# 1. redis 服务器

```c
struct redisServer {
    // ...
    // 一个数组，保存着服务器中的所有数据库
    redisDb *db;
  	//服务器的数据库数量
    int dbnum;
    // ...
};

typedef struct redisClient {
// ...
// 记录客户端当前正在使用的数据库
redisDb *db;
// ...
} redisClient;
```

<img src="img/image-20210609004514345.png" alt="image-20210609004514345" style="zoom:50%;" />



# 2. redis数据库

```c
typedef struct redisDb {
    // ...
    // 数据库键空间，保存着数据库中的所有键值对
    dict *dict;
    // 过期字典，保存着所有键的过期时间
    dict *expires;
    // ...
} redisDb;
```

![image-20210609004616567](img/image-20210609004616567.png)

# 3. 过期键

通过过期字典，程序可以用以下步骤检查一个给定键是否过期：

1）检查给定键是否存在于过期字典：如果存在，那么取得键的过期时间。

2）检查当前UNIX时间戳是否大于键的过期时间：如果是的话，那么键已经过期；否则的话，键未过期。



## 3.1 删除策略

**三种删除策略**：

- 定时删除：在设置键的过期时间的同时，创建一个定时器（timer），让定时器在键的过期时间来临时，立即执行对键的删除操作。

- 惰性删除：放任键过期不管，但是每次从键空间中获取键时，都检查取得的键是否过期，如果过期的话，就删除该键；如果没有过期，就返回该键。

- 定期删除：每隔一段时间，程序就对数据库进行一次检查，删除里面的过期键。至于要删除多少过期键，以及要检查多少个数据库，则由算法决定。



## 3.2 redis的实现的删除策略

> Redis服务器实际使用的是**惰性删除**和**定期删除**两种策略.



### 3.2.1 惰性删除策略的实现

惰性删除策略由`db.c/expireIfNeeded`函数实现，所有读写数据库的Redis命令在执行之前都会调用`expireIfNeeded`函数对输入键进行检查：

- 如果输入键已经过期，那么expireIfNeeded函数将输入键从数据库中删除。

- 如果输入键未过期，那么expireIfNeeded函数不做动作。

`expireIfNeeded`函数跟**过滤器**一样，它可以在命令真正执行之前，过滤掉过期的输入键。



### 3.2.2 定期删除策略的实现

过期键的定期删除策略由`redis.c/activeExpireCycle`函数实现，每当Redis的服务器**周期性**操作`redis.c/serverCron`函数执行时，`activeExpireCycle`函数就会被调用, 在**规定的时间**内，**分多次遍历服务器中的各个数据库**，从数据库的expires字典中**随机检查**一部分键的过期时间，并删除其中的过期键。

全局变量`current_db`会记录当前`activeExpireCycle`函数检查的进度，并在下一次activeExpireCycle函数调用时，接着上一次的进度进行处理. 



## 3.3 RDB、AOF和复制功能对过期键的处理

### 3.3.1 RDB

- 生成RDB文件时候, 过期键会被忽略.

- 恢复RDB文件时候
  - 若redis是主服务器模式运行, 那么会忽略过期键
  - 若是从服务器, 则过期键也会被恢复



### 3.3.2 AOF

- AOF写入, 当过期键被惰性删除或者定期删除之后，程序会向AOF文件追加（append）一条**DEL命令**，来显式地记录该键已被删除。

- AOF重写, 过期键会被忽略



### 3.3.3 复制

当服务器运行在复制模式下时，从服务器的过期键删除动作由主服务器控制：

- 主服务器在删除过期键之后，会向所有从服务器发送一个DEL命令。

- 从服务器在执行客户端发送的读命令时，不会做任何操作, 即使碰到过期键也照样返回。

- 从服务器只有在接到主服务器发来的DEL命令之后，才会删除过期键。

**保证主从服务器数据的一致性**.

