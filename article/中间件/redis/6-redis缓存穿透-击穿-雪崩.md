# 缓存穿透

## 现象

指**缓存和数据库中都没有的数据，而用户不断发起请求**，如发起为id为“-1”的数据或id为特别大不存在的数据。这时的用户很可能是攻击者，攻击会导致数据库压力过大。



## 方案

解决方案：

- 接口层增加校验，如用户鉴权校验，id做基础校验，id<=0的直接拦截。
- 从缓存取不到的数据，在数据库中也没有取到，可以缓存null值或者空属性对象，缓存有效时间可以设置短点，如30秒（设置太长会导致正常情况也没法使用）。这样可以防止攻击用户反复用同一个id暴力攻击。
  



# 缓存击穿

## 现象

指缓存中没有但数据库中有的数据（一般是缓存时间到期），这时由于并发用户特别多，同时读缓存没读到数据，又同时去数据库去取数据，引起数据库压力瞬间增大，造成过大压力。



## 方案

- 设置热点数据永远不过期。
- 加互斥锁, 即两个线程同时读取一个已经过期的缓存数据, 线程A读取不到数据的时候, 先获取分布式锁, 锁成功后去查库, 查询到的数据写入缓存. 同个时间点线程B也读取不到数据, 但争抢不到分布式锁, 这是sleep一会后再尝试读取数据->抢锁的过程. 



#  缓存雪崩

## 现象

缓存雪崩就是在某一个时刻，大量流量直接打到数据库上，对数据库造成巨大压力, 进而拖垮整个系统。



## 原因

1. 缓存数据大面积失效
2. redis集群挂了



## 方案

1. 如果是缓存数据大面积失效，则可以在设置过期时间的时，加随机值来错开缓存过期时间. 避免同一个时间点的数据大面积过期. 
2. 如果是redis集群挂了.需要分阶段处理. 

- 事前预案

  - 数据备份, RDB, AOF, 定期RDB数据在云存储备份一份
  - 选用哨兵模式/集群模式, 多挂几个**slave冗余**
  - 双机房部署，一套redis cluster，部分机器在一个机房，另一部分机器在另外一个机房

- 事中处理(此时redis集群已经挂了)

  - 多级缓存, 服务增加本地缓存(`ehcache`等), 在redis集群失效时候还能抗一会
  - 对源服务访问的限流以及资源隔离(`hystrix`)
  - 降级

- 事后恢复

  - 数据备份文件存在(`在服务器上没丢失或者从云存储拉下来`), 重启redis自动恢复. 
  - 备份没了或者数据过旧,  重启redis后进行快速缓存预热. 

  